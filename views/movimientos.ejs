<!--Movimientos.ejs -->
<%- include ('partials/navbar')%>
<%- include('partials/header') %>

 <main style="flex: 1;">
<section class="section">
  <div class="container">

    <!-- Título y Filtro -->
    <div class="columns is-vcentered is-mobile mb-5">
      <div class="column is-8">
        <h1 class="title is-2">Movimientos</h1>
      </div>
      <div class="column is-4 has-text-right">
        <div class="field is-grouped is-justify-content-flex-end">
          <label class="label mr-2 mt-2">Filtrar por fecha</label>
          <div class="control">
            <input class="input" type="date" id="filterDate">
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor dinámico de movimientos  -->
    <div id="movimientosPorFecha">

      <!-- Movimientos desde la base de datos -->
      <% if (typeof movimientos !== 'undefined' && movimientos && movimientos.length > 0) { %>
        <% 
        // Agrupar movimientos por fecha
        const movimientosPorFecha = {};
        movimientos.forEach(movimiento => {
          const fecha = new Date(movimiento.fecha).toLocaleDateString('es-ES');
          if (!movimientosPorFecha[fecha]) {
            movimientosPorFecha[fecha] = [];
          }
          movimientosPorFecha[fecha].push(movimiento);
        });
        %>
        
        <% Object.keys(movimientosPorFecha).forEach(fecha => { %>
          <div class="mb-6">
            <p class="has-text-weight-bold mb-3"><%= fecha %></p>
            
            <% movimientosPorFecha[fecha].forEach(movimiento => { %>
              <div class="box mb-3">
                <p><strong>Tipo:</strong> <%= movimiento.tipoMovimiento %></p>
                <p><strong>Producto:</strong> <%= movimiento.Producto ? movimiento.Producto.nameProducto : 'Sin producto' %></p>
                <p><strong>Proveedor:</strong> <%= movimiento.Proveedor ? movimiento.Proveedor.nameproveedor : 'Sin proveedor' %></p>
                <p><strong>Cantidad:</strong> <%= movimiento.cantidad %></p>
                <p><strong>Precio:</strong> $<%= movimiento.precio ? movimiento.precio.toLocaleString() : '0' %></p>
                <p><strong>Fecha:</strong> <%= new Date(movimiento.fecha).toLocaleDateString('es-ES') %></p>
              </div>
            <% }) %>
          </div>
        <% }) %>
      <% } else { %>
        <div class="box has-text-centered">
          <p class="has-text-grey">No hay movimientos registrados</p>
        </div>
      <% } %>

      <!-- ejemplo: 07-07-2025 -->
      <div class="mb-6">
        <p class="has-text-weight-bold mb-3">07-07-2025</p>

        <!-- Movimiento 1 -->
        <div class="box mb-3">
          <p><strong>Tipo:</strong> Entrada</p>
          <p><strong>Producto:</strong> Cubrebocas</p>
          <p><strong>Proveedor:</strong> SafeHealth</p>
          <p><strong>Cantidad:</strong> 1000</p>
          <p><strong>Precio:</strong> $2,000.00</p>
          <p><strong>Fecha:</strong> 07-07-2025</p>
        </div>
      </div>

    </div>
  </div>
</section>
 </main>
 
<%- include('partials/footer') %>