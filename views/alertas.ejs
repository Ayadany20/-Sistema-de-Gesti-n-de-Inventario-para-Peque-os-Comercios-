<!-- alertas.ejs -->
 <%- include ('partials/navbar')%>
 <%- include('partials/header') %>

<main style="flex: 1;">
  <section class="section">
    <div class="container">
      <div class="columns is-vcentered is-mobile mb-5">
        <div class="column is-4">
          <h1 class="title is-2">Alertas</h1>
        </div>
        <div class="column is-4">
          <div class="field">
            <label class="label">Filtrar por:</label>
            <div class="control">
              <div class="select is-fullwidth">
                <select id="filtroStatus">
                  <option>Todos</option>
                  <option>Pendientes</option>
                  <option>Finalizadas</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="column is-4">
          <div class="field">
            <label class="label">Filtrar por fecha</label>
            <div class="control">
              <input class="input" type="date" id="filtroFecha">
            </div>
          </div>
        </div>
      </div>

      <!-- Alertas desde la base de datos -->
      <% if (typeof alertas !== 'undefined' && alertas && alertas.length > 0) { %>
        <% alertas.forEach((alerta, index) => { %>
          <div class="box alerta-item mb-4">
            <div class="is-flex is-align-items-center is-justify-content-space-between">
              <button class="delete mr-3" aria-label="eliminar" onclick="eliminarAlerta(<%= alerta.alertaId %>)"></button>

              <div class="alerta-titulo has-background-white-ter p-2 has-text-weight-semibold is-clickable mr-3" onclick="toggleDetalle(<%= index %>)">
                <%= alerta.titulo || 'Alerta sin título' %>
              </div>

              <div class="field">
                <input type="checkbox" class="checkbox marcarFinalizada" <%= alerta.estado === 'finalizada' ? 'checked' : '' %> onchange="cambiarEstado(<%= alerta.alertaId %>, this.checked)">
              </div>
            </div>

            <div class="detalle-alerta is-hidden mt-3" id="detalle-<%= index %>">
              <p><strong>Descripción:</strong> <%= alerta.descripcion || 'Sin descripción' %></p>
              <p><strong>Tipo:</strong> <%= alerta.tipoAlerta || 'General' %></p>
              <p><strong>Estado:</strong> 
                <span class="tag <%= alerta.estado === 'finalizada' ? 'is-success' : 'is-warning' %>">
                  <%= alerta.estado === 'finalizada' ? 'Finalizada' : 'Pendiente' %>
                </span>
              </p>
              <p><strong>Usuario:</strong> <%= alerta.Usuario ? alerta.Usuario.nombre : 'Sin usuario' %></p>
              <p><strong>Fecha de creación:</strong> <%= new Date(alerta.fechaCreacion).toLocaleString('es-ES') %></p>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="box has-text-centered">
          <p class="has-text-grey">No hay alertas registradas</p>
        </div>
      <% } %>
          <p><strong>Producto:</strong> Jeringas</p>
          <p><strong>Fecha:</strong> 08-07-2025</p>
          <p><strong>Mensaje:</strong> Nivel bajo de inventario</p>
          <p><strong>Estado:</strong> Activa</p>
        </div>
      </div>

      <!-- Alerta 2 -->
      <div class="box alerta-item mb-4">
        <div class="is-flex is-align-items-center is-justify-content-space-between">
          <button class="delete mr-3" aria-label="eliminar"></button>

          <div class="alerta-titulo has-background-white-ter p-2 has-text-weight-semibold is-clickable mr-3">
            Alerta Producto 2
          </div>

          <div class="field">
            <input type="checkbox" class="checkbox marcarFinalizada">
          </div>
        </div>

        <div class="detalle-alerta is-hidden mt-3">
          <p><strong>Producto:</strong> Guantes</p>
          <p><strong>Fecha:</strong> 07-07-2025</p>
          <p><strong>Mensaje:</strong> Inventario crítico</p>
          <p><strong>Estado:</strong> Activa</p>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Mostrar detalles al dar clic en el título de la alerta
      document.querySelectorAll('.alerta-titulo').forEach(titulo => {
        titulo.addEventListener('click', () => {
          const detalle = titulo.closest('.alerta-item').querySelector('.detalle-alerta');
          detalle.classList.toggle('is-hidden');
        });
      });

      // Eliminar alerta
      document.querySelectorAll('.delete').forEach(btn => {
        btn.addEventListener('click', () => {
          const alerta = btn.closest('.alerta-item');
          alerta.remove();
        });
      });

      // Marcar como finalizada
      document.querySelectorAll('.marcarFinalizada').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const alerta = checkbox.closest('.alerta-item');
          alerta.classList.toggle('has-background-light', checkbox.checked);
          alerta.style.opacity = checkbox.checked ? 0.6 : 1;
        });
      });
    });
  </script>
</main>
 
<%- include('partials/footer') %>